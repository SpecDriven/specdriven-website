---
// Contact form with Web3Forms integration, honeypot protection, UTM tracking
---

<section id="contact" class="section-padding bg-gradient-to-br from-charcoal to-gray-900 text-white relative overflow-hidden">
  <!-- Background geometric pattern -->
  <div class="absolute inset-0 pattern-grid opacity-20"></div>

  <!-- Floating geometric shapes -->
  <div class="absolute top-20 right-20 w-32 h-32 bg-gradient-primary opacity-20 rounded-full animate-float" style="animation-delay: 1s;"></div>
  <div class="absolute bottom-32 left-16 w-24 h-24 border-2 border-indigo-300 opacity-30 transform rotate-45 animate-pulse-slow"></div>

  <div class="max-w-7xl mx-auto container-padding relative">
    <!-- Section Header -->
    <div class="text-center mb-20">
      <h2 class="text-h1 font-heading font-bold text-white mb-6">
        Ready to Transform Your Development Process?
      </h2>
      <p class="text-xl text-gray-100 max-w-3xl mx-auto text-balance">
        Connect with our experts to discover how spec-driven development can accelerate your delivery and align your teams.
      </p>
    </div>

    <div class="grid lg:grid-cols-2 gap-12">
      <!-- Contact Form -->
      <div class="glass rounded-2xl border-2 border-white/20 p-8 bg-white/10">
        <h3 class="text-2xl font-heading font-bold text-white mb-6">
          Send Us a Message
        </h3>

        <form id="contact-form" action="https://api.web3forms.com/submit" method="POST" class="space-y-6">
          <!-- Web3Forms Access Key -->
          <input type="hidden" name="access_key" id="web3forms-key" value="">

          <!-- Honeypot for spam protection -->
          <input type="checkbox" name="botcheck" id="botcheck" style="display: none;">

          <!-- UTM and Attribution Fields (hidden) -->
          <input type="hidden" name="utm_source" id="utm_source" value="">
          <input type="hidden" name="utm_medium" id="utm_medium" value="">
          <input type="hidden" name="utm_campaign" id="utm_campaign" value="">
          <input type="hidden" name="utm_term" id="utm_term" value="">
          <input type="hidden" name="utm_content" id="utm_content" value="">
          <input type="hidden" name="referrer" id="referrer" value="">
          <input type="hidden" name="landing_page" id="landing_page" value="">

          <!-- Form Configuration -->
          <input type="hidden" name="subject" value="New Lead from Spec-Driven Website">
          <input type="hidden" name="from_name" value="Spec-Driven Website">
          <input type="hidden" name="redirect" value="https://specdriven.app/thank-you">

          <!-- Name Field -->
          <div>
            <label for="name" class="block text-sm font-medium text-gray-200 mb-2">
              Full Name *
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-3 bg-white/90 border border-white/30 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-colors text-charcoal placeholder-gray-500"
              placeholder="Your full name"
            >
          </div>

          <!-- Email Field -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-200 mb-2">
              Email Address *
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 bg-white/90 border border-white/30 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-colors text-charcoal placeholder-gray-500"
              placeholder="your.email@company.com"
            >
          </div>

          <!-- Company Field -->
          <div>
            <label for="company" class="block text-sm font-medium text-gray-200 mb-2">
              Company *
            </label>
            <input
              type="text"
              id="company"
              name="company"
              required
              class="w-full px-4 py-3 bg-white/90 border border-white/30 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-colors text-charcoal placeholder-gray-500"
              placeholder="Your company name"
            >
          </div>

          <!-- Role Field -->
          <div>
            <label for="role" class="block text-sm font-medium text-gray-200 mb-2">
              Role *
            </label>
            <select
              id="role"
              name="role"
              required
              class="w-full px-4 py-3 bg-white/90 border border-white/30 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-colors text-charcoal"
            >
              <option value="">Select your role</option>
              <option value="Product Manager">Product Manager</option>
              <option value="Head of Product">Head of Product</option>
              <option value="Product Director">Product Director</option>
              <option value="Engineering Manager">Engineering Manager</option>
              <option value="QA Manager">QA Manager</option>
              <option value="Test Lead">Test Lead</option>
              <option value="Senior Developer">Senior Developer</option>
              <option value="UX Designer">UX Designer</option>
              <option value="CTO">CTO</option>
              <option value="VP Engineering">VP Engineering</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <!-- Phone Field (Optional) -->
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-200 mb-2">
              Phone Number
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              class="w-full px-4 py-3 bg-white/90 border border-white/30 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-colors text-charcoal placeholder-gray-500"
              placeholder="+1 (555) 123-4567"
            >
          </div>

          <!-- Team Size -->
          <div>
            <label for="team_size" class="block text-sm font-medium text-gray-200 mb-2">
              Development Team Size
            </label>
            <select
              id="team_size"
              name="team_size"
              class="w-full px-4 py-3 bg-white/90 border border-white/30 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-colors text-charcoal"
            >
              <option value="">Select team size</option>
              <option value="1-10">1-10 people</option>
              <option value="11-30">11-30 people</option>
              <option value="31-100">31-100 people</option>
              <option value="100+">100+ people</option>
            </select>
          </div>

          <!-- Message Field -->
          <div>
            <label for="message" class="block text-sm font-medium text-gray-200 mb-2">
              Message *
            </label>
            <textarea
              id="message"
              name="message"
              required
              rows="4"
              class="w-full px-4 py-3 bg-white/90 border border-white/30 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-colors resize-y text-charcoal placeholder-gray-500"
              placeholder="Tell us about your current challenges with product development and what you'd like to achieve..."
            ></textarea>
          </div>

          <!-- Privacy Consent -->
          <div class="flex items-start space-x-3">
            <input
              type="checkbox"
              id="consent"
              name="consent"
              required
              class="mt-1 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-white/30 rounded bg-white/90"
            >
            <label for="consent" class="text-sm text-gray-200">
              I agree to the <a href="/privacy" class="text-indigo-300 hover:text-indigo-200 underline">privacy policy</a> and consent to being contacted about spec-driven development services. *
            </label>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            id="submit-btn"
            class="w-full btn-primary text-lg py-4 font-semibold shadow-lg hover:shadow-xl transition-all duration-200"
          >
            <span id="submit-text">Send Message</span>
            <span id="submit-loading" class="hidden">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Sending...
            </span>
          </button>

          <!-- Form Messages -->
          <div id="form-message" class="hidden p-4 rounded-lg"></div>
        </form>
      </div>

      <!-- Contact Information & CTA -->
      <div class="space-y-8">
        <!-- Calendly CTA -->
        <div class="glass rounded-2xl p-8 border-2 border-indigo-300/30 bg-gradient-primary/20">
          <div class="text-center">
            <div class="w-16 h-16 bg-gradient-primary rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
              <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 3H18V1H16V3H8V1H6V3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V8H19V19Z"/>
              </svg>
            </div>
            <h3 class="text-2xl font-heading font-bold text-charcoal mb-4">
              Prefer to Talk?
            </h3>
            <p class="text-gray-700 mb-6 text-balance">
              Schedule a 30-minute assessment call to discuss your specific needs and see how spec-driven development can transform your team.
            </p>
            <button
              class="bg-white text-indigo-600 px-8 py-4 rounded-lg font-semibold text-lg hover:bg-indigo-50 transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-0.5"
              data-calendly-source="contact-calendar"
            >
              Schedule Assessment Call
            </button>
          </div>
        </div>

        <!-- Contact Information -->
        <div class="glass rounded-2xl border-2 border-white/20 p-8 bg-white/10">
          <h3 class="text-xl font-heading font-bold text-white mb-6">
            Other Ways to Connect
          </h3>

          <div class="space-y-4">
            <!-- Email -->
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 8L12 13L4 8V6L12 11L20 6V8Z"/>
                </svg>
              </div>
              <div>
                <div class="font-medium text-white">Email</div>
                <a href="mailto:leads@specdriven.app" class="text-indigo-300 hover:text-indigo-200">
                  leads@specdriven.app
                </a>
              </div>
            </div>

            <!-- Response Time -->
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20M12.5 7H11V13L16.25 16.15L17 14.92L12.5 12.25V7Z"/>
                </svg>
              </div>
              <div>
                <div class="font-medium text-white">Response Time</div>
                <div class="text-gray-100">Within 24 hours</div>
              </div>
            </div>

            <!-- Time Zone -->
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2M12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20M12.5 7H11V13L16.25 16.15L17 14.92L12.5 12.25V7Z"/>
                </svg>
              </div>
              <div>
                <div class="font-medium text-white">Available Hours</div>
                <div class="text-gray-100">9 AM - 6 PM PST</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Success Stories -->
        <div class="glass rounded-2xl p-6 border-2 border-emerald-300/30 bg-gradient-emerald/20">
          <h4 class="font-semibold text-charcoal mb-3">
            What Our Clients Say
          </h4>
          <blockquote class="text-gray-700 text-sm italic">
            "Spec-driven development transformed our delivery process. We went from 6-week feature cycles to 2-week cycles with better quality."
          </blockquote>
          <div class="text-emerald-600 text-sm mt-2 font-medium">
            â€” Director of Product, Fortune 500 Company
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import { handleCalendlyClick, preloadCalendlyScript } from '../lib/calendly';
  import { getAttributionData } from '../lib/utm';

  // Handle contact calendar CTA
  const contactCalendarButton = document.querySelector('[data-calendly-source="contact-calendar"]');
  if (contactCalendarButton) {
    // Preload script on hover/focus
    contactCalendarButton.addEventListener('mouseenter', preloadCalendlyScript);
    contactCalendarButton.addEventListener('focus', preloadCalendlyScript);

    // Handle click
    contactCalendarButton.addEventListener('click', (e) => {
      e.preventDefault();
      handleCalendlyClick('contact-calendar');
    });
  }

  // Initialize form with environment variables and UTM data
  document.addEventListener('DOMContentLoaded', () => {
    // Set Web3Forms access key
    const web3formsKey = document.getElementById('web3forms-key');
    if (web3formsKey && import.meta.env.VITE_WEB3FORMS_ACCESS_KEY) {
      web3formsKey.value = import.meta.env.VITE_WEB3FORMS_ACCESS_KEY;
    }

    // Populate UTM fields
    const attributionData = getAttributionData();
    if (attributionData) {
      Object.keys(attributionData).forEach(key => {
        const field = document.getElementById(key);
        if (field && attributionData[key]) {
          field.value = attributionData[key];
        }
      });
    }

    // Set current page as landing page if not already set
    const landingPageField = document.getElementById('landing_page');
    if (landingPageField && !landingPageField.value) {
      landingPageField.value = window.location.href;
    }

    // Set referrer if not already set
    const referrerField = document.getElementById('referrer');
    if (referrerField && !referrerField.value) {
      referrerField.value = document.referrer || 'direct';
    }
  });

  // Handle form submission
  const contactForm = document.getElementById('contact-form');
  if (contactForm) {
    contactForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitLoading = document.getElementById('submit-loading');
      const formMessage = document.getElementById('form-message');

      // Show loading state
      submitBtn.disabled = true;
      submitText.classList.add('hidden');
      submitLoading.classList.remove('hidden');

      try {
        const formData = new FormData(contactForm);

        // Check honeypot
        if (formData.get('botcheck')) {
          throw new Error('Spam detected');
        }

        const response = await fetch(contactForm.action, {
          method: 'POST',
          body: formData,
        });

        if (response.ok) {
          // Success
          formMessage.className = 'p-4 rounded-lg bg-green-50 border border-green-200 text-green-800';
          formMessage.textContent = 'Thank you! Your message has been sent successfully. We\'ll get back to you within 24 hours.';
          formMessage.classList.remove('hidden');

          // Reset form
          contactForm.reset();

          // Track successful submission
          if (typeof window !== 'undefined' && 'gtag' in window) {
            (window as any).gtag('event', 'form_submit', {
              event_category: 'engagement',
              event_label: 'contact_form',
              value: 1,
            });
          }

          // Show scheduling option
          setTimeout(() => {
            const schedulePrompt = document.createElement('div');
            schedulePrompt.className = 'mt-4 p-4 rounded-lg bg-primary-50 border border-primary-200';
            schedulePrompt.innerHTML = `
              <p class="text-primary-800 mb-3">Want to fast-track the conversation?</p>
              <button
                class="btn-primary"
                onclick="handleCalendlyClick('contact-form-success')"
              >
                Schedule Assessment Call
              </button>
            `;
            formMessage.appendChild(schedulePrompt);
          }, 2000);

        } else {
          throw new Error('Form submission failed');
        }
      } catch (error) {
        // Error
        formMessage.className = 'p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
        formMessage.textContent = 'Sorry, there was an error sending your message. Please try again or contact us directly at leads@specdriven.app';
        formMessage.classList.remove('hidden');

        console.error('Form submission error:', error);
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      }
    });
  }

  // Form validation improvements
  const requiredFields = document.querySelectorAll('input[required], select[required], textarea[required]');
  requiredFields.forEach(field => {
    field.addEventListener('blur', () => {
      if (!field.value.trim()) {
        field.classList.add('border-red-400');
        field.classList.remove('border-white/30');
      } else {
        field.classList.remove('border-red-400');
        field.classList.add('border-white/30');
      }
    });

    field.addEventListener('input', () => {
      if (field.value.trim()) {
        field.classList.remove('border-red-400');
        field.classList.add('border-white/30');
      }
    });
  });

  // Email validation
  const emailField = document.getElementById('email');
  if (emailField) {
    emailField.addEventListener('blur', () => {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (emailField.value && !emailRegex.test(emailField.value)) {
        emailField.classList.add('border-red-400');

        // Show validation message
        let errorMsg = emailField.parentElement.querySelector('.error-message');
        if (!errorMsg) {
          errorMsg = document.createElement('div');
          errorMsg.className = 'error-message text-red-300 text-sm mt-1';
          emailField.parentElement.appendChild(errorMsg);
        }
        errorMsg.textContent = 'Please enter a valid email address';
      } else {
        emailField.classList.remove('border-red-400');
        const errorMsg = emailField.parentElement.querySelector('.error-message');
        if (errorMsg) {
          errorMsg.remove();
        }
      }
    });
  }
</script>